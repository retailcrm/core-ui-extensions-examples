# Основная идея

Данный репозиторий демонстрирует как встраивать внешние приложения в CRM. 
Основная идея - предоставить функционал для реализации удаленных приложений, используя который разработчики могут написать собственные реализации виджетов (или любое другое приложение) расширяющее функционал ядра не затрагивая и не ломая функционал CRM.
Для этого выбран подход с удаленным рендерингом. Код удаленного приложения выполняется в изолированной среде - iFrame,
что позволяет загружать расширения безопасным и надежным способом, в то время как хост (код, который отображает пользовательский интерфейс) является частью основного приложения.
Связь между удаленным приложением и хостом осуществляется через [postMessage](https://developer.mozilla.org/ru/docs/Web/API/Window/postMessage).

Удаленное приложение содержит ограничения на используемый функционал Vue и JS. 
Ниже описаны компоненты, api ядра и тд., что доступно и недоступно в рамках реализации собственных приложений.
Более подробно об архитектуре и api библиотеки для удаленного рендеринга можно прочитать в документации [@omnicajs/vue-remote](https://github.com/omnicajs/vue-remote/)

## Используемые технологии

* В качестве UI фреймворка используется Vue 3. Компоненты ниже основаны на нем
* [@omnicajs/vue-remote](https://github.com/omnicajs/vue-remote/) используется для рендеринга удаленного приложения и коммуницаии с host приложением
* [@remote-ui/rpc](https://www.npmjs.com/package/@remote-ui/rpc) используется для создания канала коммуникации между host и remote приложениями

## Ядро предоставляет следующие компоненты:

```text
    UiButton,
    UiError,
    UiLink,
    UiLoader,
    UiMenuItem,
    UiMenuItemGroup,
    UiModalSidebar,
    UiModalWindow,
    UiModalWindowSurface,
    UiScrollbar,
    UiTag,
    UiTransition,
    CrmYandexMap,
    CrmPlacement
```

Более подробно познакомиться с этими компонентами можно на [витрине](https://design.retailcrm.tech/omnica-vue3/index.html).

Доступны props, слоты (дефолтные и именнованные). Методы компонентов, компонент Transition, scoped slots, refs, директивы (кроме v-if/v-show) и модификаторы на данный момент недоступны.

Доступны события:
```javascript
    InputEvent,
    DragEvent,
    FocusEvent,
    KeyboardEvent,
    PointerEvent,
    WheelEvent,
    MouseEvent,
    TouchEvent
```

Актуальный список событий можно посмотреть [тут](https://github.com/omnicajs/vue-remote/blob/main/src/vue/host/events.ts#L142)

## В ядре доступно встраивание удаленных приложений в следующих местах(scope):
1. Карточка просмотра клиента (физ лицо) `customer-card`
2. Карточка редактирования клиента (физ лицо) `customer-form`
3. Карточка заказа `order-card`

Только для карточки заказа доступно api.

## API Ядра в карточке заказа

```javascript
api.getPlacement
```
Возвращает информацию о placement (места встраивания компонентов приложения в интерфейс CRM).
Метод принимает 2 параметра - имя плейсмента и название скоупа.
Возвращает массив объектов вида {id, context}, где id - идентификатор точки монтирования, context - специфическая информация для текущего placement.

```javascript
api.getCustomerEmail 
```
Возвращает значение `string`
Значение поля "Email"

```javascript
api.setCustomerEmail
```
Принимает значение `(): string | null`
Устанавливает переданное значение в поле "Email"

```javascript
api.getCustomerPhone 
```
Возвращает значение `string`
Значение поля "Телефон"

```javascript
api.setCustomerPhone
```
Принимает значение `(): string | null`
Устанавливает переданное значение в поле "Телефон"

```javascript
api.getDeliveryAddress 
```
Возвращает значение `string`
Значение поля "Адрес"

```javascript
api.setDeliveryAddress
```
Принимает значение `(): string | null`
Устанавливает переданное значение в поле "Адрес"

```javascript
api.parseDeliveryAddress
```
Парсит адрес в соответствующем поле

Стили должны быть модульными

## Монтирование компонентов в интерфейсе хостового приложения
Для монтирования компонентов используется компонент ```CrmPlacement```. В него следует обернуть компоненты приложения, которые должны быть смонтированы в конкретной точке хостового приложения.
Компонент имеет обязательный входной параметр ```placementId``` - идентификатор точки монтирования.

Для того, чтобы получить список доступных точек монтирования, нужно вызвать метод ```api.getPlacement(placementName, scopeName)```, который вернет массив объектов вида {id, context}, где
id - идентификатор точки монтирования, context - объект с информацией, специфичной для данной точки.

Например, для плеймента ```customer-phone```, контекст будет вида ```{ phone: string }```.

## В удаленном приложении нужно описать используемые компоненты
```typescript
const CrmYandexMap = defineRemoteComponent('CrmYandexMap', [
    'change',
] as unknown as { 'change': (address: string) => void })

export { UiButton, UiModalWindow, CrmYandexMap }
```
Более подробно можно посмотреть в документации [@omnicajs/vue-remote](https://github.com/omnicajs/vue-remote/)

## Инициализация расширения
В CRM доступна функция `extensionsInit`, которую можно вызвать в консоли для инициализации расширения.
В качестве параметра функция принимает массив объектов вида:

```javascript
[{
    entrypoint: 'extension-url',
    scope: 'order-card',
    stylesheet: 'stylesheet-url',
    uuid: '1'
}]
```

`extension-url` - адрес страницы с подключаемыми скриптами сборки расширения.
`stylesheet-url` - файл стилей расширения.

В текущем расширении сервер, возвращающий перечисленные ресурсы, описан в файле [server.mjs](https://github.com/retailcrm/core-ui-extensions-examples/blob/master/server.mjs).

## Требования к архиву

Архив должен содержать следующие файлы:
- Файл `manifest.json`, описывает метаданные модуля. Он содержит информацию, необходимую для правильной интеграции и работы модуля в CRM
- HTML файл (`*.html`). Является точкой входа для расширения
- CSS файл (`extension.*.css`). Необязательный файл, который является стилями расширения
- JS файлы (`extension.*.js`). Файлы с кодом расширения. В архиве должен присутствовать хотя бы 1 файл.

### Структура `manifest.json`

Файл `manifest.json` содержит метаданные для расширения и создается автоматически при выполнении команды `make zip-archive`. Пример содержимого файла `manifest.json`:

```json
{
  "code": "core-ui-extensions",
  "version": 1,
  "scope": ["order"],
  "entrypoint": "index.html",
  "scripts": ["extension.js"],
  "stylesheet": "extension.css"
}
```

Где:
- `code: string`. Уникальный код расширения. Обязательный параметр
- `version: number`. Версия расширения. Значение должно быть целым числом и больше 0. Обязательный параметр
- `scope: string[]`. Область применения расширения. Обязательный параметр
- `entrypoint: string`. HTML файл, который является точкой входа для расширения. Обязательный параметр
- `scripts: string[]`. JS файлы расширения. Обязательный параметр
- `stylesheet: ?string`. CSS файл расширения. Необязательный параметр

### Команда для создания архива

Для создания архива с необходимыми файлами и `manifest.json`, используйте команду:

```bash
make zip-archive
```

# Пример удаленного приложения на основе @omnicajs/vue-remote

## Описание примеров

### 1. Адрес доставки на карте

Пример представляет собой модальное окно с интерактивной картой от Яндекса. Маркер можно перетаскивать и тем самым изменять адрес.
Используется JavaScript API Яндекс Карт и Геокодер версии 3.0. При первоначальной отрисовке позиционирование маркера происходит
исходя из адреса в поле "Адрес", далее при перетаскивании маркера адрес выбирается исходя из текущих координат маркера, выбирается
ближайший адрес к текущим координатам. При нажатии кнопки "Выбрать", происходит заполнение или обновление адреса в поле
"Адрес".

### 2. Кнопки перехода в мессенджеры

Пример позволяет добавить рядом с номером телефона клиента на странице заказа и клиента кнопки перехода в мессенджеры по этому номеру.

## Запуск

### Начальное развертывание

Установка зависимостей
```bash
yarn install
```

Сборка приложения
```bash
yarn build
```

Сборка архива `core-ui-extensions-examples.zip`
```bash
make zip-archive
```

Для инициализации приложения внутри CRM необходимо выполнить его сборку (```yarn build```), а затем предоставить html страницу с подключенными скриптами сборки в качестве значения ```entrypoint```, а так же файл стилей в качестве значения ```stylesheet``` объекта конфигурации.

В данном примере есть [файл сервера](https://github.com/retailcrm/core-ui-extensions-examples/blob/master/server.mjs), который отдает необходимые ресурсы и после сборки приложения достаточно его запустить с помощью команды ```node server.mjs```.

После этого, на странице заказа в CRM достаточно вызвать в консоли браузера метод ```extensionsInit```:

```javascript
extensionsInit([{
    entrypoint: 'http://localhost:3000/extension/62aa8145-ed53-4862-b28f-f1bc6b36a3a3',
    scope: ['order-card', 'customer-card'],
    stylesheet: 'http://localhost:3000/extension/62aa8145-ed53-4862-b28f-f1bc6b36a3a3/stylesheet',
    uuid: '1'
}])
```

На странице заказа в секции "Отгрузка и доставка" под полем "Адрес" должна появиться кнопка "На карте". При клике на кнопку открывается модальное окно с картой.
Для работы карты нужен api ключ.

Рядом с номером телефона клиента должны появиться кнопки перехода в мессенджеры.
